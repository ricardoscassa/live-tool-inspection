<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Inspection App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            /* iOS optimizations */
            -webkit-text-size-adjust: 100%;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection for textareas and inputs */
        textarea, input {
            -webkit-user-select: text;
            user-select: text;
        }
        
        .container {
            max-width: 900px; /* Increased max-width for better layout */
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            flex: 1;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* Main Menu Styles */
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        
        .menu-button {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .menu-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .menu-button.secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .menu-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        /* Room Input Page Styles */
        .room-input-section {
            margin-bottom: 25px;
        }
        
        .room-input-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
            font-size: 1.1rem;
        }
        
        .room-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
            /* iOS optimizations */
            -webkit-appearance: none;
            appearance: none;
        }
        
        .room-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .help-text {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 50px;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button.secondary {
            background: #6c757d;
        }
        
        .button.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .button.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Sequential Check Page Styles */
        .room-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .room-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 10px;
        }

        /* Enhanced Custom Dropdown Styles with Visual Indicators */
        .custom-dropdown {
            position: relative;
            width: 100%;
            margin-top: 10px;
        }

        .custom-dropdown-button {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            /* iOS optimizations */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .custom-dropdown-button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .custom-dropdown-button:hover {
            border-color: #667eea;
        }

        .custom-dropdown-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #667eea;
        }

        .custom-dropdown-button.open .custom-dropdown-arrow {
            transform: rotate(180deg);
        }

        .custom-dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .custom-dropdown-options.show {
            display: block;
        }

        .custom-dropdown-option {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            /* iOS optimizations */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .custom-dropdown-option:last-child {
            border-bottom: none;
        }

        .custom-dropdown-option:hover {
            background-color: #f8f9fa;
        }

        .custom-dropdown-option.selected {
            background-color: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        /* Visual Status Indicators for Dropdown Options */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid transparent;
        }

        .status-indicator.completed {
            background-color: #4caf50;
            border-color: #2e7d32;
        }

        .status-indicator.no-access {
            background-color: #f44336;
            border-color: #c62828;
        }

        .status-indicator.default {
            background-color: #e0e0e0;
            border-color: #bdbdbd;
        }

        /* Alternative: Use checkmark and X symbols */
        .status-symbol {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .status-symbol.completed {
            color: #4caf50;
        }

        .status-symbol.completed::before {
            content: "âœ“";
        }

        .status-symbol.no-access {
            color: #f44336;
        }

        .status-symbol.no-access::before {
            content: "âœ—";
        }

        .status-symbol.default {
            color: #bdbdbd;
        }

        .status-symbol.default::before {
            content: "â—‹";
        }

        /* Custom dropdown status color coding for button */
        .custom-dropdown-button.no-access {
            background-color: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .custom-dropdown-button.completed {
            background-color: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .custom-dropdown-button.no-access:focus {
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
        }

        .custom-dropdown-button.completed:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .room-select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            background-color: white;
            appearance: none; /* Remove default browser styling */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23667eea%22%20d%3D%22M287%2C114.7L157.4%2C244.3c-2.3%2C2.3-5.3%2C3.5-8.4%2C3.5s-6.1-1.2-8.4-3.5L5.4%2C114.7c-4.7-4.7-4.7-12.3%2C0-17s12.3-4.7%2C17%2C0l135%2C135l135-135c4.7-4.7%2C12.3-4.7%2C17%2C0S291.7%2C110%2C287%2C114.7z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            cursor: pointer;
            transition: border-color 0.3s ease;
            /* iOS optimizations */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .room-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Room status color coding */
        .room-select.no-access {
            background-color: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .room-select.completed {
            background-color: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .room-select.no-access:focus {
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
        }

        .room-select.completed:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .checks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .check-item {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .check-item.checked {
            background: #e8f5e8;
            border-color: #28a745;
        }

        .check-label {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            font-size: 1rem;
        }

        .check-buttons {
            display: flex;
            gap: 10px;
        }

        .check-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .check-btn.yes {
            color: #28a745;
            border-color: #28a745;
        }

        .check-btn.yes.active {
            background: #28a745;
            color: white;
        }

        .check-btn.no {
            color: #dc3545;
            border-color: #dc3545;
        }

        .check-btn.no.active {
            background: #dc3545;
            color: white;
        }

        /* Code Check Page Styles */
        .code-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .code-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 10px;
            word-break: break-all;
        }
        
        .progress-info {
            color: #666;
            font-size: 1rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .code-inspection-grid {
            display: grid;
            grid-template-columns: 1fr 150px 250px; /* Code | Status Button | Comment */
            gap: 10px;
            margin-bottom: 30px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
        }

        .grid-header {
            font-weight: 700;
            background-color: #f0f2f5;
            padding: 10px;
            border-bottom: 1px solid #e1e5e9;
            text-align: center;
        }

        .grid-row {
            display: contents; /* Allows children to be placed directly in grid */
        }

        .grid-cell {
            padding: 10px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            align-items: center;
            word-break: break-all;
        }

        .grid-cell:nth-child(3n+1) { /* Code column */
            background-color: #fdfdfd;
        }

        .grid-cell:nth-child(3n+2) { /* Status button column */
            background-color: #f8f8f8;
            justify-content: center;
        }

        .grid-cell:nth-child(3n) { /* Comment column */
            background-color: #fdfdfd;
        }

        .grid-row:last-child .grid-cell {
            border-bottom: none; /* Remove bottom border for last row */
        }

        .status-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .status-button:hover {
            background: #5a6cdb;
        }

        .status-button.selected {
            background: #28a745;
        }

        .status-options {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
            display: none;
            flex-direction: column;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-options.active {
            display: flex;
        }

        .status-option {
            padding: 10px 15px;
            cursor: pointer;
            white-space: nowrap;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .status-option:hover {
            background-color: #f0f0f0;
        }

        /* Enhanced Comment Section with Predefined Choices */
        .comment-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .comment-choices {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .comment-choice-btn {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .comment-choice-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .comment-choice-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .comment-textarea {
            width: 100%;
            min-height: 38px; /* Adjusted for single line */
            padding: 8px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
            /* iOS optimizations */
            -webkit-appearance: none;
            appearance: none;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* Room status buttons */
        .room-status-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .status-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .status-btn.no-access {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .status-btn.no-access:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .status-btn.completed {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
        }

        .status-btn.completed:hover {
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e1e5e9;
        }
        
        .nav-button {
            padding: 12px 25px;
            font-size: 1rem;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-buttons .button {
            flex: 1;
            min-width: 200px;
        }
        
        /* Success States */
        .success-message {
            text-align: center;
            padding: 40px;
            color: #28a745;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        /* File upload styles */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            margin-bottom: 15px;
        }

        .file-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .file-input-label {
            display: block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px dashed transparent;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .file-input-label.drag-over {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            word-break: break-all;
        }

        /* SE/ST/SV specific styles */
        .se-st-sv-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .entries-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .entry-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
        }

        .entry-label {
            font-weight: 600;
            color: #333;
            min-width: 30px;
            flex-shrink: 0;
        }

        .entry-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
            min-width: 0; /* Allow input to shrink on small screens */
            /* iOS optimizations */
            -webkit-appearance: none;
            appearance: none;
        }

        .entry-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .remove-entry-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
            flex-shrink: 0;
            white-space: nowrap;
            /* iOS touch optimization */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .remove-entry-btn:hover {
            background: #c82333;
        }

        /* Message modal styles */
        .message-content {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #333;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .modal-buttons .button {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
        }
        
        /* Responsive Design - Enhanced for iOS */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .code-inspection-grid {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
            .grid-header, .grid-cell {
                text-align: left;
                justify-content: flex-start;
            }
            .grid-cell:nth-child(3n+1), .grid-cell:nth-child(3n+2), .grid-cell:nth-child(3n) {
                background-color: #fdfdfd; /* Uniform background */
            }
            .status-button {
                max-width: none;
            }
            .status-options {
                position: relative; /* Adjust for mobile */
                width: 100%;
            }
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .button {
                min-width: auto;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-button {
                width: 100%;
            }
            
            .room-select {
                font-size: 0.9rem;
                padding: 8px;
            }

            /* Enhanced mobile dropdown styling */
            .custom-dropdown-option {
                padding: 12px 15px;
                font-size: 1rem;
            }

            .status-indicator {
                width: 14px;
                height: 14px;
            }

            .status-symbol {
                width: 18px;
                height: 18px;
                font-size: 14px;
            }

            /* SE/ST/SV mobile improvements */
            .se-st-sv-section {
                padding: 15px;
                margin-bottom: 20px;
            }

            .entry-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 12px;
            }

            .entry-label {
                min-width: auto;
                text-align: center;
                font-size: 1.1rem;
            }

            .textarea-wrapper {
                position: relative;
                width: 100%;
            }

            .entry-textarea {
                min-height: 150px; /* Increased height for better usability */
                font-size: 1.1rem;
                padding: 12px;
                padding-right: 50px; /* Extra space for counter on mobile */
                text-align: left; /* Align text to left for multi-line input */
            }

            .code-count {
                position: absolute;
                bottom: 8px;
                right: 8px;
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 6px 10px;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: bold;
                display: none; /* Hidden by default */
                z-index: 10;
                pointer-events: none; /* Prevent interference with textarea interaction */
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                min-width: 24px;
                text-align: center;
            }

            .remove-entry-btn {
                align-self: center;
                padding: 10px 20px;
                font-size: 1rem;
            }

            /* Mobile optimizations for code counter */
            .code-count {
                bottom: 10px;
                right: 10px;
                font-size: 1rem; /* Slightly larger for mobile */
                padding: 8px 12px;
                border-radius: 10px;
                min-width: 28px;
            }

            /* Enhanced comment choices for mobile */
            .comment-choices {
                gap: 8px;
                margin-bottom: 10px;
            }

            .comment-choice-btn {
                padding: 8px 14px;
                font-size: 0.9rem;
                border-radius: 8px;
            }

            .comment-textarea {
                min-height: 44px; /* Larger touch target for iOS */
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .code-title {
                font-size: 1.3rem;
            }

            .se-st-sv-section {
                padding: 10px;
            }

            .entry-item {
                padding: 10px;
            }

            .entry-input {
                font-size: 1rem;
                padding: 10px;
            }

            .remove-entry-btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            /* Extra small screen optimizations for code counter */
            .code-count {
                bottom: 12px;
                right: 12px;
                font-size: 1.1rem; /* Even larger for very small screens */
                padding: 10px 14px;
                border-radius: 12px;
                min-width: 32px;
            }

            /* Enhanced comment choices for very small screens */
            .comment-choice-btn {
                padding: 10px 16px;
                font-size: 1rem;
                border-radius: 10px;
            }

            .comment-textarea {
                min-height: 48px; /* Even larger touch target */
                font-size: 16px;
                padding: 12px;
            }
        }

        /* iOS Safari specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .button, .check-btn, .status-btn, .comment-choice-btn {
                -webkit-appearance: none;
                border-radius: 10px;
            }
            
            .room-textarea, .comment-textarea, .entry-input {
                -webkit-appearance: none;
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Room Inspection App V2.0</h1>
            <p>Comprehensive room and code inspection system</p>
        </div>

        <!-- Main Menu Page -->
        <div id="mainMenuPage" class="page active">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Choose Inspection Type</h2>
                <div class="menu-buttons">
                    <button id="siteInspectionBtn" class="menu-button primary">
                        EA - Inspection
                        <div style="font-size: 0.9rem; font-weight: normal; margin-top: 5px; opacity: 0.8;">
                            ROOM-BY-ROOM INSPECTION
                        </div>
                    </button>
                    <button id="codeInspectionBtn" class="menu-button secondary">
                        ECS INSPECTION
                        <div style="font-size: 0.9rem; font-weight: normal; margin-top: 5px; opacity: 0.8;">
                            Room codes with detailed checks
                        </div>
                    </button>
                    <button id="roomSeStSvInspectionBtn" class="menu-button" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white;">
                        Room Inspection SE/ST/SV
                        <div style="font-size: 0.9rem; font-weight: normal; margin-top: 5px; opacity: 0.8;">
                            Room number with SE/ST/SV entries
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Room Input Page (Original) -->
        <div id="roomInputPage" class="page">
            <div class="card">
                <div class="room-input-section">
                    <label for="roomList">Enter Room Names/Numbers:</label>
                    <textarea
                        id="roomList"
                        class="room-textarea"
                        placeholder="Enter room names, one per line:"
                    ></textarea>
                    <div class="help-text">
                        Enter each room name or number on a separate line. You can paste a list from another source.
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="startInspection" class="button">Start Inspection</button>
                    <button id="loadSavedData" class="button secondary">Load Saved Data</button>
                    <button id="exportJsonData" class="button secondary">Download Data (JSON)</button>
                    <button id="importJsonData" class="button secondary">Upload Data (JSON)</button>
                    <button id="resetApp" class="button danger">Reset Application</button>
                    <button id="backToMainMenu" class="button secondary">Back to Menu</button>
                </div>
            </div>
        </div>

        <!-- Code Input Page (New) -->
        <div id="codeInputPage" class="page">
            <div class="card">
                <div class="room-input-section">
                    <label for="codeList">Enter Room Codes:</label>
                    <textarea
                        id="codeList"
                        class="room-textarea"
                        placeholder="Enter room codes in the format:
Room Codes (Room- Codes)
1HLF0000ZL- 1HLF01ST0000
1HLF0001ZL- 1HLF10SV0000
1HLF10ST0000
1LHF10SE0000 
..."
                    ></textarea>
                    <div class="help-text">
                        Enter room codes with their associated codes. Use the format shown above. Each line can contain a room code followed by its associated codes, or just individual codes.
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="startCodeInspection" class="button">Start Inspection</button>
                    <button id="loadSavedCodeData" class="button secondary">Load Saved Data</button>
                    <button id="exportCodeJsonData" class="button secondary">Download Data (JSON)</button>
                    <button id="importCodeJsonData" class="button secondary">Upload Data (JSON)</button>
                    <button id="resetCodeApp" class="button danger">Reset Application</button>
                    <button id="backToMainMenuFromCode" class="button secondary">Back to Menu</button>
                </div>
            </div>
        </div>

        <!-- Check Page (Original) -->
        <div id="checkPage" class="page">
            <div class="card">
                <div class="room-header">
                    <h2 id="currentRoomTitle" class="room-title">Room 101</h2>
                    <div id="roomSelect" class="custom-dropdown">
                        <button class="custom-dropdown-button" type="button">
                            <span class="custom-dropdown-text">Select Room</span>
                            <span class="custom-dropdown-arrow">â–¼</span>
                        </button>
                        <div class="custom-dropdown-options"></div>
                    </div>
                    <div class="room-status-buttons">
                        <button id="noAccessBtn" class="status-btn no-access">No Access</button>
                        <button id="completedBtn" class="status-btn completed">Access</button>
                    </div>
                    <div id="progressInfo" class="progress-info">Room 1 of 5</div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 20%"></div>
                    </div>
                </div>
                <div id="checksContainer" class="checks-grid">
                </div>
                <div class="navigation">
                    <button id="prevRoom" class="button nav-button secondary">Previous Room</button>
                    <button id="nextRoom" class="button nav-button">Next Room</button>
                </div>
                <div class="action-buttons">
                    <button id="exportExcel" class="button success">Export to CSV</button>
                    <button id="backToInput" class="button secondary">Back to Input</button>
                </div>
            </div>
        </div>

        <!-- Code Check Page (Enhanced with Predefined Comment Choices) -->
        <div id="codeCheckPage" class="page">
            <div class="card">
                <div class="code-header">
                    <h2 id="currentCodeRoomTitle" class="code-title">Room: 1HLF0104ZL</h2>
                    <div id="codeRoomSelect" class="custom-dropdown">
                        <button class="custom-dropdown-button" type="button">
                            <span class="custom-dropdown-text">Select Room</span>
                            <span class="custom-dropdown-arrow">â–¼</span>
                        </button>
                        <div class="custom-dropdown-options"></div>
                    </div>
                    <div class="room-status-buttons">
                        <button id="codeNoAccessBtn" class="status-btn no-access">No Access</button>
                        <button id="codeCompletedBtn" class="status-btn completed">Access</button>
                    </div>
                    <div id="codeProgressInfo" class="progress-info">Room 1 of 5</div>
                    <div class="progress-bar">
                        <div id="codeProgressFill" class="progress-fill" style="width: 20%"></div>
                    </div>
                </div>
                <div id="codeChecksContainer" class="code-inspection-grid">
                    <!-- Headers -->
                    <div class="grid-header">Code</div>
                    <div class="grid-header">Status</div>
                    <div class="grid-header">Comment</div>
                    <!-- Code rows will be inserted here by JavaScript -->
                </div>
                <div class="navigation">
                    <button id="prevCodeRoom" class="button nav-button secondary">Previous Room</button>
                    <button id="nextCodeRoom" class="button nav-button">Next Room</button>
                </div>
                <div class="action-buttons">
                    <button id="exportCodeExcel" class="button success">Export to CSV</button>
                    <button id="backToCodeInput" class="button secondary">Back to Input</button>
                </div>
            </div>
        </div>

        <!-- Room SE/ST/SV Input Page (New) -->
        <div id="roomSeStSvInputPage" class="page">
            <div class="card">
                <div class="room-input-section">
                    <label for="roomNumbers">Enter Room Numbers:</label>
                    <textarea
                        id="roomNumbers"
                        class="room-textarea"
                        placeholder="Enter room numbers, one per line:
..."
                    ></textarea>
                    <div class="help-text">
                        Enter each room number on a separate line. The first 6 characters will be used as prefix for SE/ST/SV codes. All rooms should have the same prefix format for consistency.
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="startSeStSvInspection" class="button">Start SE/ST/SV Inspection</button>
                    <button id="loadSavedSeStSvData" class="button secondary">Load Saved Data</button>
                    <button id="exportSeStSvJsonData" class="button secondary">Download Data (JSON)</button>
                    <button id="importSeStSvJsonData" class="button secondary">Upload Data (JSON)</button>
                    <button id="resetSeStSvApp" class="button danger">Reset Application</button>
                    <button id="backToMainMenuFromSeStSv" class="button secondary">Back to Menu</button>
                </div>
            </div>
        </div>

        <!-- Room SE/ST/SV Check Page (Enhanced) -->
        <div id="roomSeStSvCheckPage" class="page">
            <div class="card">
                <div class="room-header">
                    <h2 id="currentSeStSvRoomTitle" class="room-title">Room: 1ABC0172BA</h2>
                    <div id="seStSvRoomSelect" class="custom-dropdown">
                        <button class="custom-dropdown-button" type="button">
                            <span class="custom-dropdown-text">Select Room</span>
                            <span class="custom-dropdown-arrow">â–¼</span>
                        </button>
                        <div class="custom-dropdown-options"></div>
                    </div>
                    <div class="room-status-buttons">
                        <button id="seStSvNoAccessBtn" class="status-btn no-access">No Access</button>
                        <button id="seStSvCompletedBtn" class="status-btn completed">Access</button>
                    </div>
                    <div id="seStSvProgressInfo" class="progress-info">Room 1 of 3</div>
                    <div class="progress-bar">
                        <div id="seStSvProgressFill" class="progress-fill" style="width: 33%"></div>
                    </div>
                </div>
                
                <div id="seStSvContainer">
                    <!-- SE Section -->
                    <div class="se-st-sv-section">
                        <h3 style="color: #333; margin-bottom: 15px;">SE</h3>
                        <div class="textarea-wrapper">
                            <textarea class="entry-textarea" id="seTextarea" placeholder="Enter SE codes, one per line"></textarea>
                            <span class="code-count" id="seCount"></span>
                        </div>
                    </div>

                    <!-- ST Section -->
                    <div class="se-st-sv-section">
                        <h3 style="color: #333; margin-bottom: 15px;">ST</h3>
                        <div class="textarea-wrapper">
                            <textarea class="entry-textarea" id="stTextarea" placeholder="Enter ST codes, one per line. You can use:
- Short codes with clamps: 1111-2 (4 digits code - qty of clamps)
- Whole room numbers: 1ABC01ST0123 (complete room number)
- Whole room numbers with clamps: 1ABC01ST0123-2 (complete room number - qty of clamps)"></textarea>
                            <span class="code-count" id="stCount"></span>
                        </div>
                    </div>

                    <!-- SV Section -->
                    <div class="se-st-sv-section">
                        <h3 style="color: #333; margin-bottom: 15px;">SV</h3>
                        <div class="textarea-wrapper">
                            <textarea class="entry-textarea" id="svTextarea" placeholder="Enter SV codes, one per line"></textarea>
                            <span class="code-count" id="svCount"></span>
                        </div>
                    </div>
                </div>

                <div class="navigation">
                    <button id="prevSeStSvRoom" class="button nav-button secondary">Previous Room</button>
                    <button id="nextSeStSvRoom" class="button nav-button">Next Room</button>
                </div>
                <div class="action-buttons">
                    <button id="exportSeStSvCsv" class="button success">Export to CSV</button>
                    <button id="backToSeStSvInput" class="button secondary">Back to Input</button>
                </div>
            </div>
        </div>

        <!-- Completion Page -->
        <div id="completionPage" class="page">
            <div class="card">
                <div class="success-message">
                    <h2 style="margin-bottom: 20px;">ðŸŽ‰ Inspection Complete!</h2>
                    <p>All rooms have been inspected successfully.</p>
                </div>
                <div class="action-buttons">
                    <button id="exportExcelComplete" class="button success">Export to CSV</button>
                    <button id="continueEditingComplete" class="button secondary">Continue Editing</button>
                    <button id="backToMainMenuComplete" class="button secondary">Back to Menu</button>
                </div>
            </div>
        </div>

        <!-- Reset Confirmation Modal -->
        <div id="resetModal" class="modal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; color: #dc3545;">Reset Application</h3>
                <p style="margin-bottom: 20px;">Are you sure you want to reset the application? This will delete all data and cannot be undone.</p>
                <div class="modal-buttons">
                    <button id="confirmReset" class="button danger">Reset</button>
                    <button id="cancelReset" class="button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- File Upload Modal -->
        <div id="fileUploadModal" class="modal">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; color: #333;">Upload Data File</h3>
                <div class="file-input-wrapper">
                    <input type="file" id="jsonFileInput" class="file-input" accept=".json">
                    <label for="jsonFileInput" class="file-input-label">
                        Choose JSON File or Drag & Drop
                    </label>
                    <div id="fileName" class="file-name"></div>
                </div>
                <div class="modal-buttons">
                    <button id="uploadFile" class="button">Upload</button>
                    <button id="cancelUpload" class="button secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div id="messageModal" class="modal">
            <div class="modal-content">
                <h3 id="messageTitle" style="margin-bottom: 20px; color: #333;">Message</h3>
                <p id="messageContent" class="message-content">Message content here</p>
                <div class="modal-buttons">
                    <button id="messageOk" class="button">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let appState = {
            rooms: [],
            currentRoomIndex: 0,
            checkData: {},
            roomStatus: {},
            isInspectionMode: false,
            roomCodes: {},
            currentCodeRoomIndex: 0,
            codeSpecificComments: {},
            seStSvRooms: [],
            currentSeStSvRoomIndex: 0,
            seStSvData: {}
        };

        // Predefined comment choices for ECS Inspection
        const commentChoices = [
            "Previously Installed",
            "Can be Installed",
            "Issue with Install",
            "No Access"
        ];

        // Check labels for site inspection
        const checkLabels = [
            'Bylor',
            'MEH',
            'Other',
            'Walled in eqpt',
            'Other eqpt',
            'SSW',
            'Supports',
            'Pipes',
            'Clumps',
            'Cable trays',
            'Cables',
            'CBS',
            'HVAC/Ducting',
            'Not started',
            'Partially installed',
            'Mostly installed',
            'Fully installed',
            'Hydrodem',
            'Access egress routes',
            'Stored eqpt',
            'Floor',
            'Walls',
            'In progress',
            'Comments'
        ];

        // Grouped check labels for better organization
        const groupedCheckLabels = [
            { group: 'Is there anyone working in the room?', questions: ['Bylor', 'MEH', 'Other'] },
            { group: 'What\'s installed?', questions: ['Walled in eqpt', 'Other eqpt', 'SSW', 'Supports', 'Pipes', 'Clumps', 'Cable trays', 'Cables', 'CBS','HVAC/Ducting'] },
            { group: 'Support installation status', questions: ['Not started', 'Partially installed', 'Mostly installed', 'Fully installed'] },
            { group: 'Are there any obstruction present to MEH work?', questions: ['Hydrodem', 'Access egress routes', 'Stored eqpt'] },
            { group: 'Coating', questions: ['Floor', 'Walls', 'In progress'] },
            { group: 'Comments', questions: ['Comments'] }
        ];

        // Status options for code inspection
        const codeStatusOptions = [
            'Available',
            'CBS Installation',
            'Clamps Not welded',
            'Embedment Plate not surveyed',
            'Embedment Plate PIA Required',
            'Equipment/Material Blocking Work Access',
            'No Access - Unable To Verify',
            'Previously Installed',
            'Protection Covering Embedment Plate',
            'Room Not Available',
            'Possible Scaffold Amendment Required',
            'Supports Not installed Pipe/Tray/Duct',
            'TCO (Temporary Construction Opening)',
            'Embedment Plate Labelled Wrong',
            'Embedment plate Not available',
            'Non-Conforming Product TAG on support',
            'NDT Required On Supports'
        ];

        // DOM elements
        const roomListTextarea = document.getElementById('roomList');
        const codeListTextarea = document.getElementById('codeList');
        const roomNumbersTextarea = document.getElementById('roomNumbers');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromStorage();
            setupEventListeners();
            
            // Check if we're in inspection mode and show appropriate page
            if (appState.isInspectionMode) {
                refreshUIFromState();
            } else {
                showMainMenu();
            }
        });

        function setupEventListeners() {
            // Main menu buttons
            document.getElementById('siteInspectionBtn').addEventListener('click', showRoomInputPage);
            document.getElementById('codeInspectionBtn').addEventListener('click', showCodeInputPage);
            document.getElementById('roomSeStSvInspectionBtn').addEventListener('click', showRoomSeStSvInputPage);

            // Room input page buttons
            document.getElementById('startInspection').addEventListener('click', startInspection);
            document.getElementById('loadSavedData').addEventListener('click', loadSavedData);
            document.getElementById('exportJsonData').addEventListener('click', downloadJsonData);
            document.getElementById('importJsonData').addEventListener('click', () => showFileUploadModal('site'));
            document.getElementById('resetApp').addEventListener('click', () => showResetModal('site'));
            document.getElementById('backToMainMenu').addEventListener('click', showMainMenu);

            // Code input page buttons
            document.getElementById('startCodeInspection').addEventListener('click', startCodeInspection);
            document.getElementById('loadSavedCodeData').addEventListener('click', loadSavedData);
            document.getElementById('exportCodeJsonData').addEventListener('click', downloadJsonData);
            document.getElementById('importCodeJsonData').addEventListener('click', () => showFileUploadModal('code'));
            document.getElementById('resetCodeApp').addEventListener('click', () => showResetModal('code'));
            document.getElementById('backToMainMenuFromCode').addEventListener('click', showMainMenu);

            // SE/ST/SV input page buttons
            document.getElementById('startSeStSvInspection').addEventListener('click', startSeStSvInspection);
            document.getElementById('loadSavedSeStSvData').addEventListener('click', loadSavedData);
            document.getElementById('exportSeStSvJsonData').addEventListener('click', downloadJsonData);
            document.getElementById('importSeStSvJsonData').addEventListener('click', () => showFileUploadModal('seStSv'));
            document.getElementById('resetSeStSvApp').addEventListener('click', () => showResetModal('seStSv'));
            document.getElementById('backToMainMenuFromSeStSv').addEventListener('click', showMainMenu);

            // Check page buttons
            document.getElementById('prevRoom').addEventListener('click', () => navigateRoom(-1));
            document.getElementById('nextRoom').addEventListener('click', () => navigateRoom(1));
            document.getElementById('exportExcel').addEventListener('click', exportToCsv);
            document.getElementById('backToInput').addEventListener('click', backToInput);

            // Code check page buttons
            document.getElementById('prevCodeRoom').addEventListener('click', () => navigateCodeRoom(-1));
            document.getElementById('nextCodeRoom').addEventListener('click', () => navigateCodeRoom(1));
            document.getElementById('exportCodeExcel').addEventListener('click', exportCodeToCsv);
            document.getElementById('backToCodeInput').addEventListener('click', backToCodeInput);

            // SE/ST/SV check page buttons
            document.getElementById('prevSeStSvRoom').addEventListener('click', () => navigateSeStSvRoom(-1));
            document.getElementById('nextSeStSvRoom').addEventListener('click', () => navigateSeStSvRoom(1));
            document.getElementById('exportSeStSvCsv').addEventListener('click', exportSeStSvToCsv);
            document.getElementById('backToSeStSvInput').addEventListener('click', backToSeStSvInput);

            // Room status buttons
            document.getElementById('noAccessBtn').addEventListener('click', () => setRoomStatus('no-access'));
            document.getElementById('completedBtn').addEventListener('click', () => setRoomStatus('completed'));
            document.getElementById('codeNoAccessBtn').addEventListener('click', () => setCodeRoomStatus('no-access'));
            document.getElementById('codeCompletedBtn').addEventListener('click', () => setCodeRoomStatus('completed'));
            document.getElementById('seStSvNoAccessBtn').addEventListener('click', () => setSeStSvRoomStatus('no-access'));
            document.getElementById('seStSvCompletedBtn').addEventListener('click', () => setSeStSvRoomStatus('completed'));

            // Completion page buttons
            document.getElementById('exportExcelComplete').addEventListener('click', exportToCsv);
            document.getElementById('continueEditingComplete').addEventListener('click', showCheckPage);
            document.getElementById('backToMainMenuComplete').addEventListener('click', showMainMenu);

            // Modal buttons
            document.getElementById('confirmReset').addEventListener('click', confirmReset);
            document.getElementById('cancelReset').addEventListener('click', hideResetModal);
            document.getElementById('uploadFile').addEventListener('click', uploadFile);
            document.getElementById('cancelUpload').addEventListener('click', hideFileUploadModal);
            document.getElementById('messageOk').addEventListener('click', hideMessageModal);

            // Custom dropdown setup
            setupCustomDropdown('roomSelect', (index) => {
                appState.currentRoomIndex = index;
                updateCheckPage();
                updateCheckStates();
                saveDataToStorage();
            });

            setupCustomDropdown('codeRoomSelect', (index) => {
                appState.currentCodeRoomIndex = index;
                updateCodeCheckPage();
                generateCodeCheckItems();
                updateCodeCheckStates();
                saveDataToStorage();
            });

            setupCustomDropdown('seStSvRoomSelect', (index) => {
                appState.currentSeStSvRoomIndex = index;
                updateSeStSvPage();
                generateSeStSvEntries();
                saveDataToStorage();
            });

            // File input handling
            const fileInput = document.getElementById('jsonFileInput');
            const fileLabel = document.querySelector('.file-input-label');
            const fileName = document.getElementById('fileName');

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    fileName.textContent = e.target.files[0].name;
                } else {
                    fileName.textContent = '';
                }
            });

            // Drag and drop functionality
            fileLabel.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileLabel.classList.add('drag-over');
            });

            fileLabel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileLabel.classList.remove('drag-over');
            });

            fileLabel.addEventListener('drop', function(e) {
                e.preventDefault();
                fileLabel.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    fileName.textContent = e.dataTransfer.files[0].name;
                }
            });
        }

        // Page navigation functions
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function showMainMenu() {
            showPage('mainMenuPage');
        }

        function showRoomInputPage() {
            showPage('roomInputPage');
        }

        function showCodeInputPage() {
            showPage('codeInputPage');
        }

        function showRoomSeStSvInputPage() {
            showPage('roomSeStSvInputPage');
        }

        function showCheckPage() {
            showPage('checkPage');
        }

        function showCodeCheckPage() {
            showPage('codeCheckPage');
        }

        function showRoomSeStSvCheckPage() {
            showPage('roomSeStSvCheckPage');
        }

        function showCompletionPage() {
            showPage('completionPage');
        }

        function backToSeStSvInput() {
            appState.isInspectionMode = false;
            saveDataToStorage();
            showRoomSeStSvInputPage();
        }

        // Custom dropdown functionality
        function setupCustomDropdown(dropdownId, onSelectCallback) {
            const dropdown = document.getElementById(dropdownId);
            const button = dropdown.querySelector('.custom-dropdown-button');
            const options = dropdown.querySelector('.custom-dropdown-options');
            const arrow = dropdown.querySelector('.custom-dropdown-arrow');

            button.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                const isOpen = options.classList.contains('show');
                
                // Close all other dropdowns
                document.querySelectorAll('.custom-dropdown-options').forEach(opt => {
                    opt.classList.remove('show');
                });
                document.querySelectorAll('.custom-dropdown-button').forEach(btn => {
                    btn.classList.remove('open');
                });

                if (!isOpen) {
                    options.classList.add('show');
                    button.classList.add('open');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!dropdown.contains(e.target)) {
                    options.classList.remove('show');
                    button.classList.remove('open');
                }
            });

            // Handle option selection with improved event handling
            options.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                
                // Find the option element (might be the target or a parent)
                let optionElement = e.target;
                while (optionElement && !optionElement.classList.contains('custom-dropdown-option')) {
                    optionElement = optionElement.parentElement;
                    if (optionElement === options) {
                        return; // Clicked on container, not an option
                    }
                }
                
                if (optionElement && optionElement.classList.contains('custom-dropdown-option')) {
                    const index = parseInt(optionElement.dataset.index);
                    if (!isNaN(index)) {
                        options.classList.remove('show');
                        button.classList.remove('open');
                        onSelectCallback(index);
                    }
                }
            });
        }

        function updateCustomDropdownOptions(dropdownId, items, selectedIndex) {
            const dropdown = document.getElementById(dropdownId);
            const button = dropdown.querySelector('.custom-dropdown-button');
            const textSpan = button.querySelector('.custom-dropdown-text');
            const options = dropdown.querySelector('.custom-dropdown-options');

            // Update button text
            if (items.length > 0 && selectedIndex >= 0 && selectedIndex < items.length) {
                textSpan.textContent = items[selectedIndex];
            } else {
                textSpan.textContent = 'Select Room';
            }

            // Update options
            options.innerHTML = '';
            items.forEach((item, index) => {
                const option = document.createElement('div');
                option.className = 'custom-dropdown-option';
                option.dataset.index = index;
                
                // Add status indicator
                const indicator = document.createElement('div');
                const status = getRoomStatus(item);
                indicator.className = `status-symbol ${status}`;
                option.appendChild(indicator);
                
                const text = document.createElement('span');
                text.textContent = item;
                option.appendChild(text);
                
                if (index === selectedIndex) {
                    option.classList.add('selected');
                }
                
                options.appendChild(option);
            });
        }

        // Room navigation functions
        function navigateRoom(direction) {
            const newIndex = appState.currentRoomIndex + direction;
            
            if (newIndex >= 0 && newIndex < appState.rooms.length) {
                appState.currentRoomIndex = newIndex;
                updateCheckPage();
                updateCheckStates();
                saveDataToStorage();
            } else if (newIndex >= appState.rooms.length) {
                // Completed all rooms
                showCompletionPage();
            }
        }

        function navigateCodeRoom(direction) {
            const roomNames = Object.keys(appState.roomCodes);
            const newIndex = appState.currentCodeRoomIndex + direction;
            
            if (newIndex >= 0 && newIndex < roomNames.length) {
                appState.currentCodeRoomIndex = newIndex;
                updateCodeCheckPage();
                generateCodeCheckItems();
                updateCodeCheckStates();
                saveDataToStorage();
            } else if (newIndex >= roomNames.length) {
                // Completed all rooms
                showCompletionPage();
            }
        }

        function navigateSeStSvRoom(direction) {
            const newIndex = appState.currentSeStSvRoomIndex + direction;
            
            if (newIndex >= 0 && newIndex < appState.seStSvRooms.length) {
                appState.currentSeStSvRoomIndex = newIndex;
                updateSeStSvPage();
                generateSeStSvEntries();
                saveDataToStorage();
            } else if (newIndex >= appState.seStSvRooms.length) {
                // Completed all rooms
                showCompletionPage();
            }
        }

        // Data persistence functions
        function saveDataToStorage() {
            try {
                localStorage.setItem('roomInspectionApp', JSON.stringify(appState));
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        function loadDataFromStorage() {
            try {
                const saved = localStorage.getItem('roomInspectionApp');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    appState = { ...appState, ...parsedData };
                }
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        function refreshUIFromState() {
            if (appState.rooms.length > 0) {
                roomListTextarea.value = appState.rooms.join('\n');
                generateCheckItems();
                showCheckPage();
                updateCheckPage();
                updateCheckStates();
            } else if (Object.keys(appState.roomCodes).length > 0) {
                // Reconstruct code list textarea
                let codeText = '';
                for (const room in appState.roomCodes) {
                    if (appState.roomCodes[room].length > 0) {
                        codeText += `${room}- ${appState.roomCodes[room].join(' ')}\n`;
                    }
                }
                codeListTextarea.value = codeText;
                generateCodeCheckItems();
                showCodeCheckPage();
                updateCodeCheckPage();
                updateCodeCheckStates();
            } else if (appState.seStSvRooms.length > 0) {
                roomNumbersTextarea.value = appState.seStSvRooms.join('\n');
                showRoomSeStSvCheckPage();
                updateSeStSvPage();
                generateSeStSvEntries();
            }
        }

        // Update check page
        function updateCheckPage() {
            if (appState.rooms.length === 0) return;
            
            const currentRoom = appState.rooms[appState.currentRoomIndex];
            document.getElementById('currentRoomTitle').textContent = currentRoom;
            
            // Update progress info
            document.getElementById('progressInfo').textContent = 
                `Room ${appState.currentRoomIndex + 1} of ${appState.rooms.length}`;
            
            // Update progress bar
            const progressPercent = ((appState.currentRoomIndex + 1) / appState.rooms.length) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            
            // Update room selector
            updateRoomSelector();
            
            // Update room select color based on status
            updateRoomSelectColor();
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prevRoom');
            const nextBtn = document.getElementById('nextRoom');
            
            prevBtn.disabled = appState.currentRoomIndex === 0;
            
            if (appState.currentRoomIndex === appState.rooms.length - 1) {
                nextBtn.textContent = 'Complete';
            } else {
                nextBtn.textContent = 'Next Room';
            }
        }

        function updateRoomSelector() {
            updateCustomDropdownOptions('roomSelect', appState.rooms, appState.currentRoomIndex);
        }

        // Update code check page
        function updateCodeCheckPage() {
            const roomNames = Object.keys(appState.roomCodes);
            if (roomNames.length === 0) return;
            
            const currentRoom = roomNames[appState.currentCodeRoomIndex];
            document.getElementById('currentCodeRoomTitle').textContent = `Room: ${currentRoom}`;
            
            // Update progress info
            document.getElementById('codeProgressInfo').textContent = 
                `Room ${appState.currentCodeRoomIndex + 1} of ${roomNames.length}`;
            
            // Update progress bar
            const progressPercent = ((appState.currentCodeRoomIndex + 1) / roomNames.length) * 100;
            document.getElementById('codeProgressFill').style.width = `${progressPercent}%`;
            
            // Update room selector
            updateCodeRoomSelector();
            
            // Update room select color based on status
            updateCodeRoomSelectColor();
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prevCodeRoom');
            const nextBtn = document.getElementById('nextCodeRoom');
            
            prevBtn.disabled = appState.currentCodeRoomIndex === 0;
            
            if (appState.currentCodeRoomIndex === roomNames.length - 1) {
                nextBtn.textContent = 'Complete';
            } else {
                nextBtn.textContent = 'Next Room';
            }
        }

        function updateCodeRoomSelector() {
            const roomNames = Object.keys(appState.roomCodes);
            updateCustomDropdownOptions('codeRoomSelect', roomNames, appState.currentCodeRoomIndex);
        }

        // Update check button states for site inspection
        function updateCheckStates() {
            const currentRoom = appState.rooms[appState.currentRoomIndex];
            const roomData = appState.checkData[currentRoom] || new Array(checkLabels.length).fill(null);

            roomData.forEach((value, index) => {
                const checkButtons = document.querySelectorAll(`[data-check="${index}"]`);
                
                checkButtons.forEach(btn => {
                    if (btn.tagName === 'BUTTON') {
                        btn.classList.remove('active');
                        if (value !== null && parseInt(btn.dataset.value) === value) {
                            btn.classList.add('active');
                        }
                    } else if (btn.tagName === 'TEXTAREA') {
                        btn.value = value || '';
                    }
                });
            });

            // Update check item backgrounds
            document.querySelectorAll('.check-item').forEach((item, index) => {
                const value = roomData[index];
                if (value === 1) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
        }

        function getRoomStatus(roomName) {
            if (appState.roomStatus[roomName] === 'no-access') {
                return 'no-access';
            } else if (appState.roomStatus[roomName] === 'completed') {
                return 'completed';
            } else {
                return 'default';
            }
        }

        function updateCustomDropdownColor(dropdownId, status) {
            const dropdown = document.getElementById(dropdownId);
            const button = dropdown.querySelector('.custom-dropdown-button');
            button.className = 'custom-dropdown-button';
            if (status === 'no-access') {
                button.classList.add('no-access');
            } else if (status === 'completed') {
                button.classList.add('completed');
            }
        }

        function updateRoomSelectColor() {
            const currentRoom = appState.rooms[appState.currentRoomIndex];
            if (currentRoom) {
                const status = appState.roomStatus[currentRoom];
                updateCustomDropdownColor('roomSelect', status);
            }
        }

        function updateCodeRoomSelectColor() {
            const currentRoom = Object.keys(appState.roomCodes)[appState.currentCodeRoomIndex];
            if (currentRoom) {
                const status = appState.roomStatus[currentRoom];
                updateCustomDropdownColor('codeRoomSelect', status);
            }
        }

        function updateSeStSvRoomSelectColor() {
            const currentRoom = appState.seStSvRooms[appState.currentSeStSvRoomIndex];
            if (currentRoom) {
                const status = appState.roomStatus[currentRoom];
                updateCustomDropdownColor('seStSvRoomSelect', status);
            }
        }

        // Data loading and saving functions
        function loadSavedData() {
            const saved = localStorage.getItem('roomInspectionApp');
            if (saved) {
                showMessageModal('Data Loaded', 'Saved data has been loaded successfully!');
                refreshUIFromState();
            } else {
                showMessageModal('No Saved Data', 'No saved data found.');
            }
        }

        function downloadJsonData() {
            try {
                const dataStr = JSON.stringify(appState, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `room_inspection_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showMessageModal('Export Successful', 'Data exported successfully!');
            } catch (error) {
                console.error('Export failed:', error);
                showMessageModal('Export Failed', 'Failed to export data. Please try again.');
            }
        }

        function backToInput() {
            appState.isInspectionMode = false;
            saveDataToStorage();
            showRoomInputPage();
        }

        function backToCodeInput() {
            appState.isInspectionMode = false;
            saveDataToStorage();
            showCodeInputPage();
        }

        // Start inspection functions
        function startInspection() {
            const roomText = roomListTextarea.value.trim();
            if (!roomText) {
                showMessageModal('Input Required', 'Please enter room names or numbers.');
                return;
            }

            appState.rooms = roomText.split('\n').map(room => room.trim()).filter(room => room);
            appState.currentRoomIndex = 0;
            appState.checkData = {};
            appState.isInspectionMode = true;

            // Initialize check data for each room
            appState.rooms.forEach(room => {
                appState.checkData[room] = new Array(checkLabels.length).fill(null);
            });

            saveDataToStorage();
            generateCheckItems();
            showCheckPage();
            updateCheckPage();
        }

        function startCodeInspection() {
            const codeText = codeListTextarea.value.trim();
            if (!codeText) {
                showMessageModal('Input Required', 'Please enter room codes.');
                return;
            }

            // Parse room codes with improved logic
            appState.roomCodes = {};
            const lines = codeText.split('\n').map(line => line.trim()).filter(line => line);
            let currentRoom = null;
            
            lines.forEach(line => {
                if (line.includes('-')) {
                    // Line contains a room and codes
                    const parts = line.split('-');
                    if (parts.length >= 2) {
                        const room = parts[0].trim();
                        const codes = parts.slice(1).join('-').trim().split(/\s+/).filter(code => code);
                        if (!appState.roomCodes[room]) {
                            appState.roomCodes[room] = [];
                        }
                        appState.roomCodes[room] = appState.roomCodes[room].concat(codes);
                        currentRoom = room; // Set this as the current room for subsequent codes
                    }
                } else {
                    // Individual code without room association - assign to current room or unassigned
                    if (currentRoom) {
                        // Assign to the current room (the room above)
                        if (!appState.roomCodes[currentRoom]) {
                            appState.roomCodes[currentRoom] = [];
                        }
                        appState.roomCodes[currentRoom].push(line);
                    } else {
                        // No current room, assign to unassigned
                        const room = 'Unassigned';
                        if (!appState.roomCodes[room]) {
                            appState.roomCodes[room] = [];
                        }
                        appState.roomCodes[room].push(line);
                    }
                }
            });

            appState.currentCodeRoomIndex = 0;
            appState.checkData = {};
            appState.codeSpecificComments = {};
            appState.isInspectionMode = true;

            // Initialize check data for each code
            for (const room in appState.roomCodes) {
                appState.roomCodes[room].forEach(code => {
                    const uniqueCodeId = `${room}-${code}`;
                    appState.checkData[uniqueCodeId] = null; // Store index of selected status
                    appState.codeSpecificComments[uniqueCodeId] = '';
                });
            }

            saveDataToStorage();
            generateCodeCheckItems();
            showCodeCheckPage();
            updateCodeCheckPage();
        }

        function startSeStSvInspection() {
            const roomText = roomNumbersTextarea.value.trim();
            if (!roomText) {
                showMessageModal('Input Required', 'Please enter room numbers.');
                return;
            }

            appState.seStSvRooms = roomText.split('\n').map(room => room.trim()).filter(room => room);
            appState.currentSeStSvRoomIndex = 0;
            appState.seStSvData = {};
            appState.isInspectionMode = true;

            // Initialize SE/ST/SV data for each room
            appState.seStSvRooms.forEach(room => {
                appState.seStSvData[room] = {
                    'SE': [],
                    'ST': [],
                    'SV': [],
                    'Clamps': [] // Store clamp quantities for ST entries
                };
            });

            saveDataToStorage();
            showRoomSeStSvCheckPage();
            updateSeStSvPage();
            generateSeStSvEntries();
        }

        // Generate check items for site inspection
        function generateCheckItems() {
            const checksContainer = document.getElementById('checksContainer');
            checksContainer.innerHTML = '';
            
            groupedCheckLabels.forEach(group => {
                const groupHeader = document.createElement('h3');
                groupHeader.textContent = group.group;
                groupHeader.style.gridColumn = '1 / -1';
                groupHeader.style.color = '#333';
                checksContainer.appendChild(groupHeader);

                group.questions.forEach((label) => {
                    const checkIndex = checkLabels.indexOf(label);
                    const checkItem = document.createElement('div');
                    checkItem.className = 'check-item';

                    if (label === 'Comments') {
                        checkItem.innerHTML = `
                            <div class="check-label">${label}</div>
                            <textarea class="room-textarea" data-check="${checkIndex}" rows="3" placeholder="Add comments..."></textarea>
                        `;
                    } else {
                        checkItem.innerHTML = `
                            <div class="check-label">${label}</div>
                            <div class="check-buttons">
                                <button class="check-btn yes" data-check="${checkIndex}" data-value="1">Yes</button>
                                <button class="check-btn no" data-check="${checkIndex}" data-value="0">No</button>
                            </div>
                        `;
                    }

                    checksContainer.appendChild(checkItem);
                });
            });

            // Add event listeners
            document.querySelectorAll('#checksContainer .check-btn').forEach(btn => {
                btn.addEventListener('click', handleCheckClick);
            });

            document.querySelectorAll('#checksContainer textarea[data-check]').forEach(area => {
                area.addEventListener('input', handleTextInput);
            });
        }

        // Generate check items for code inspection (Excel-like layout) with enhanced comment section
        function generateCodeCheckItems() {
            const checksContainer = document.getElementById('codeChecksContainer');
            // Clear only rows, keep headers
            checksContainer.querySelectorAll('.grid-row').forEach(row => row.remove());

            const currentRoomName = Object.keys(appState.roomCodes)[appState.currentCodeRoomIndex];
            const codesForCurrentRoom = appState.roomCodes[currentRoomName] || [];

            codesForCurrentRoom.forEach((code) => {
                const uniqueCodeId = `${currentRoomName}-${code}`;

                const rowDiv = document.createElement('div');
                rowDiv.className = 'grid-row';

                // Code Cell
                const codeCell = document.createElement('div');
                codeCell.className = 'grid-cell';
                codeCell.textContent = code;
                rowDiv.appendChild(codeCell);

                // Status Button Cell
                const statusCell = document.createElement('div');
                statusCell.className = 'grid-cell';
                const statusButton = document.createElement('button');
                statusButton.className = 'status-button';
                statusButton.textContent = 'Select Status';
                statusButton.dataset.codeId = uniqueCodeId;
                statusButton.addEventListener('click', toggleStatusOptions);
                statusCell.appendChild(statusButton);

                const statusOptionsDiv = document.createElement('div');
                statusOptionsDiv.className = 'status-options';
                statusOptionsDiv.dataset.codeId = uniqueCodeId;
                codeStatusOptions.forEach((option, optionIndex) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'status-option';
                    optionDiv.textContent = option;
                    optionDiv.dataset.codeId = uniqueCodeId;
                    optionDiv.dataset.statusIndex = optionIndex;
                    optionDiv.addEventListener('click', selectCodeStatus);
                    statusOptionsDiv.appendChild(optionDiv);
                });
                statusCell.appendChild(statusOptionsDiv);
                rowDiv.appendChild(statusCell);

                // Enhanced Comment Cell with Predefined Choices
                const commentCell = document.createElement('div');
                commentCell.className = 'grid-cell';
                
                const commentSection = document.createElement('div');
                commentSection.className = 'comment-section';

                // Create dropdown select element
                const commentSelect = document.createElement('select');
                commentSelect.className = 'comment-textarea';
                commentSelect.dataset.codeId = uniqueCodeId;
                commentSelect.style.minHeight = '38px';
                commentSelect.style.cursor = 'pointer';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a comment...';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                commentSelect.appendChild(defaultOption);
                
                // Add comment choices as options
                commentChoices.forEach((choice) => {
                    const option = document.createElement('option');
                    option.value = choice;
                    option.textContent = choice;
                    commentSelect.appendChild(option);
                });
                
                commentSelect.addEventListener('change', function(event) {
                    const codeId = event.target.dataset.codeId;
                    const selectedValue = event.target.value;
                    appState.codeSpecificComments[codeId] = selectedValue;
                    saveDataToStorage();
                });
                
                commentSection.appendChild(commentSelect);

                commentCell.appendChild(commentSection);
                rowDiv.appendChild(commentCell);

                checksContainer.appendChild(rowDiv);
            });
        }

        // Handle predefined comment choice selection
        function selectCommentChoice(event) {
            event.preventDefault();
            const codeId = event.target.dataset.codeId;
            const choice = event.target.dataset.choice;
            
            // Find the textarea for this code
            const textarea = document.querySelector(`.comment-textarea[data-code-id="${codeId}"]`);
            if (textarea) {
                // Check if choice is already in the textarea
                const currentValue = textarea.value.trim();
                const choices = currentValue.split('\n').map(line => line.trim()).filter(line => line);
                
                // Toggle the choice
                const choiceIndex = choices.indexOf(choice);
                if (choiceIndex > -1) {
                    // Remove the choice
                    choices.splice(choiceIndex, 1);
                    event.target.classList.remove('selected');
                } else {
                    // Add the choice
                    choices.push(choice);
                    event.target.classList.add('selected');
                }
                
                // Update textarea value
                textarea.value = choices.join('\n');
                
                // Update app state
                appState.codeSpecificComments[codeId] = textarea.value;
                saveDataToStorage();
            }
            
            // Update button visual state
            updateCommentChoiceButtons(codeId);
        }

        // Update visual state of comment choice buttons
        function updateCommentChoiceButtons(codeId) {
            const textarea = document.querySelector(`.comment-textarea[data-code-id="${codeId}"]`);
            const choiceButtons = document.querySelectorAll(`.comment-choice-btn[data-code-id="${codeId}"]`);
            
            if (textarea && choiceButtons.length > 0) {
                const currentValue = textarea.value.trim();
                const selectedChoices = currentValue.split('\n').map(line => line.trim()).filter(line => line);
                
                choiceButtons.forEach(btn => {
                    const choice = btn.dataset.choice;
                    if (selectedChoices.includes(choice)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
        }

        // Helper function to check if a code is a whole room number
        function isWholeRoomNumber(code) {
            // Check if the code contains 'SE', 'ST', or 'SV' which indicates it's a whole room number
            return code.includes('SE') || code.includes('ST') || code.includes('SV');
        }

        // Event handlers
        function handleCheckClick(event) {
            const checkIndex = parseInt(event.target.dataset.check);
            const value = parseInt(event.target.dataset.value);
            const currentRoom = appState.rooms[appState.currentRoomIndex];
            
            if (!appState.checkData[currentRoom]) {
                appState.checkData[currentRoom] = new Array(checkLabels.length).fill(null);
            }
            
            appState.checkData[currentRoom][checkIndex] = value;
            saveDataToStorage();
            updateCheckStates();
        }

        function handleTextInput(event) {
            const checkIndex = parseInt(event.target.dataset.check);
            const value = event.target.value;
            const currentRoom = appState.rooms[appState.currentRoomIndex];
            
            if (!appState.checkData[currentRoom]) {
                appState.checkData[currentRoom] = new Array(checkLabels.length).fill(null);
            }
            
            appState.checkData[currentRoom][checkIndex] = value;
            saveDataToStorage();
        }

        function handleCodeCommentInput(event) {
            const codeId = event.target.dataset.codeId;
            const value = event.target.value;
            appState.codeSpecificComments[codeId] = value;
            saveDataToStorage();
            
            // Update choice button states
            updateCommentChoiceButtons(codeId);
        }

        function toggleStatusOptions(event) {
            event.stopPropagation();
            const codeId = event.target.dataset.codeId;
            const statusOptions = document.querySelector(`.status-options[data-code-id="${codeId}"]`);
            
            // Close all other status options
            document.querySelectorAll('.status-options').forEach(options => {
                if (options !== statusOptions) {
                    options.classList.remove('active');
                }
            });
            
            statusOptions.classList.toggle('active');
        }

        function selectCodeStatus(event) {
            const codeId = event.target.dataset.codeId;
            const statusIndex = parseInt(event.target.dataset.statusIndex);
            const statusText = event.target.textContent;
            
            appState.checkData[codeId] = statusIndex;
            
            const statusButton = document.querySelector(`.status-button[data-code-id="${codeId}"]`);
            statusButton.textContent = statusText;
            statusButton.classList.add('selected');
            
            const statusOptions = document.querySelector(`.status-options[data-code-id="${codeId}"]`);
            statusOptions.classList.remove('active');
            
            saveDataToStorage();
        }

        // Close status options when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.status-options').forEach(options => {
                options.classList.remove('active');
            });
        });

        // Room status functions
        function setRoomStatus(status) {
            const currentRoom = appState.rooms[appState.currentRoomIndex];
            if (currentRoom) {
                appState.roomStatus[currentRoom] = status;
                saveDataToStorage();
                updateRoomSelectColor();
                updateCustomDropdownOptions('roomSelect', appState.rooms, appState.currentRoomIndex);
            }
        }

        function setCodeRoomStatus(status) {
            const currentRoom = Object.keys(appState.roomCodes)[appState.currentCodeRoomIndex];
            if (currentRoom) {
                appState.roomStatus[currentRoom] = status;
                saveDataToStorage();
                updateCodeRoomSelectColor();
                updateCustomDropdownOptions('codeRoomSelect', Object.keys(appState.roomCodes), appState.currentCodeRoomIndex);
            }
        }

        function setSeStSvRoomStatus(status) {
            const currentRoom = appState.seStSvRooms[appState.currentSeStSvRoomIndex];
            if (currentRoom) {
                appState.roomStatus[currentRoom] = status;
                saveDataToStorage();
                updateSeStSvRoomSelectColor();
                updateCustomDropdownOptions('seStSvRoomSelect', appState.seStSvRooms, appState.currentSeStSvRoomIndex);
            }
        }

        // Update code check button states and comments for code inspection
        function updateCodeCheckStates() {
            const currentRoomName = Object.keys(appState.roomCodes)[appState.currentCodeRoomIndex];
            const codesForCurrentRoom = appState.roomCodes[currentRoomName] || [];

            codesForCurrentRoom.forEach(code => {
                const uniqueCodeId = `${currentRoomName}-${code}`;
                const statusIndex = appState.checkData[uniqueCodeId];
                const comment = appState.codeSpecificComments[uniqueCodeId] || '';

                // Update status button
                const statusButton = document.querySelector(`.status-button[data-code-id="${uniqueCodeId}"]`);
                if (statusButton) {
                    if (statusIndex !== null && statusIndex !== undefined) {
                        statusButton.textContent = codeStatusOptions[statusIndex];
                        statusButton.classList.add('selected');
                    } else {
                        statusButton.textContent = 'Select Status';
                        statusButton.classList.remove('selected');
                    }
                }

                // Update comment textarea
                const commentTextarea = document.querySelector(`.comment-textarea[data-code-id="${uniqueCodeId}"]`);
                if (commentTextarea) {
                    commentTextarea.value = comment;
                    // Update choice button states
                    updateCommentChoiceButtons(uniqueCodeId);
                }
            });
        }

        function updateSeStSvPage() {
            if (appState.seStSvRooms.length === 0) return;
            
            const currentRoom = appState.seStSvRooms[appState.currentSeStSvRoomIndex];
            document.getElementById('currentSeStSvRoomTitle').textContent = `Room: ${currentRoom}`;
            
            // Update progress info
            document.getElementById('seStSvProgressInfo').textContent = 
                `Room ${appState.currentSeStSvRoomIndex + 1} of ${appState.seStSvRooms.length}`;
            
            // Update progress bar
            const progressPercent = ((appState.currentSeStSvRoomIndex + 1) / appState.seStSvRooms.length) * 100;
            document.getElementById('seStSvProgressFill').style.width = `${progressPercent}%`;
            
            // Update room selector
            updateSeStSvRoomSelector();
            
            // Update room select color based on status
            updateSeStSvRoomSelectColor();
            
            // Reset and update counters when room changes
            if (typeof window.resetSeStSvCounters === 'function') {
                window.resetSeStSvCounters();
            }
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prevSeStSvRoom');
            const nextBtn = document.getElementById('nextSeStSvRoom');
            
            prevBtn.disabled = appState.currentSeStSvRoomIndex === 0;
            
            if (appState.currentSeStSvRoomIndex === appState.seStSvRooms.length - 1) {
                nextBtn.style.display = 'none'; // Hide the button when at last room
            } else {
                nextBtn.style.display = 'block'; // Show the button when not at last room
                nextBtn.textContent = 'Next Room';
            }
        }

        function updateSeStSvRoomSelector() {
            updateCustomDropdownOptions('seStSvRoomSelect', appState.seStSvRooms, appState.currentSeStSvRoomIndex);
        }

        function generateSeStSvEntries() {
            if (appState.seStSvRooms.length === 0) return;
            
            const currentRoom = appState.seStSvRooms[appState.currentSeStSvRoomIndex];
            const currentData = appState.seStSvData[currentRoom];

            const seTextarea = document.getElementById("seTextarea");
            const stTextarea = document.getElementById("stTextarea");
            const svTextarea = document.getElementById("svTextarea");

            seTextarea.value = currentData["SE"].join("\n");
            
            // For ST, reconstruct the display format with clamp quantities
            const stDisplayValues = [];
            for (let i = 0; i < currentData["ST"].length; i++) {
                const stCode = currentData["ST"][i];
                const clampQty = currentData["Clamps"] && currentData["Clamps"][i] ? currentData["Clamps"][i] : '';
                if (clampQty) {
                    stDisplayValues.push(`${stCode}-${clampQty}`);
                } else {
                    stDisplayValues.push(stCode);
                }
            }
            stTextarea.value = stDisplayValues.join("\n");
            
            svTextarea.value = currentData["SV"].join("\n");

            // Add event listeners to update appState on input
            seTextarea.oninput = (e) => handleSeStSvTextareaInput("SE", e.target.value);
            stTextarea.oninput = (e) => handleSeStSvTextareaInput("ST", e.target.value);
            svTextarea.oninput = (e) => handleSeStSvTextareaInput("SV", e.target.value);

            // Update counters after loading data
            setTimeout(() => {
                if (typeof window.updateSeStSvCounters === 'function') {
                    window.updateSeStSvCounters();
                }
            }, 100);
        }

        // Enhanced handleSeStSvTextareaInput function to support whole room numbers
        function handleSeStSvTextareaInput(type, value) {
            const currentRoom = appState.seStSvRooms[appState.currentSeStSvRoomIndex];
            
            if (type === 'ST') {
                // Parse ST codes and clamp quantities with enhanced logic for whole room numbers
                const stEntries = value.split("\n").map(line => line.trim()).filter(line => line);
                const stCodes = [];
                const clampQuantities = [];
                
                stEntries.forEach(entry => {
                    if (isWholeRoomNumber(entry)) {
                        // Handle whole room numbers (with or without clamps)
                        if (entry.includes('-')) {
                            // Whole room number with clamps (e.g., "1ABC01ST0123-2")
                            const [wholeCode, clampQty] = entry.split('-');
                            stCodes.push(wholeCode.trim());
                            clampQuantities.push(clampQty.trim());
                        } else {
                            // Whole room number without clamps (e.g., "1ABC01ST0123")
                            stCodes.push(entry);
                            clampQuantities.push(''); // No clamp quantity
                        }
                    } else if (entry.includes('-')) {
                        // Regular code with clamps (e.g., "1111-2")
                        const [code, clampQty] = entry.split('-');
                        stCodes.push(code.trim());
                        clampQuantities.push(clampQty.trim());
                    } else {
                        // Regular code without clamps (e.g., "1111")
                        stCodes.push(entry);
                        clampQuantities.push(''); // No clamp quantity
                    }
                });
                
                appState.seStSvData[currentRoom]['ST'] = stCodes;
                appState.seStSvData[currentRoom]['Clamps'] = clampQuantities;
            } else {
                // For SE and SV, process normally
                appState.seStSvData[currentRoom][type] = value.split("\n").map(code => code.trim()).filter(code => code);
            }
            
            saveDataToStorage();
        }

        // Enhanced exportSeStSvToCsv function to handle whole room numbers
        function exportSeStSvToCsv() {
            try {
                const headers = ['Room Number', 'SE', 'ST', 'Clamps', 'SV'];
                const csvRows = [];
                csvRows.push(headers.map(h => `"${String(h).replace(/"/g, '""')}"`).join(','));

                appState.seStSvRooms.forEach(room => {
                    const roomPrefix = room.substring(0, 6);
                    const roomData = appState.seStSvData[room];

                    const seCodes = roomData['SE'].filter(code => code.trim()).map(code => `${roomPrefix}SE${code}`);
                    
                    // Enhanced ST code processing
                    const stCodes = roomData['ST'].filter(code => code.trim()).map(code => {
                        if (isWholeRoomNumber(code)) {
                            // If it's a whole room number, use it as-is (no prefix needed)
                            return code;
                        } else {
                            // If it's a regular code, add the room prefix
                            return `${roomPrefix}ST${code}`;
                        }
                    });
                    
                    const svCodes = roomData['SV'].filter(code => code.trim()).map(code => `${roomPrefix}SV${code}`);
                    const clampQuantities = roomData['Clamps'] || [];

                    const maxLength = Math.max(seCodes.length, stCodes.length, svCodes.length, clampQuantities.length);

                    for (let i = 0; i < maxLength; i++) {
                        const row = [];
                        if (i === 0) {
                            row.push(room); // Room number only on the first row for this room
                        } else {
                            row.push(''); // Empty for subsequent rows of the same room
                        }
                        row.push(seCodes[i] || '');
                        row.push(stCodes[i] || '');
                        row.push(clampQuantities[i] || ''); // Clamp quantity
                        row.push(svCodes[i] || '');
                        csvRows.push(row.map(c => `"${String(c).replace(/"/g, '""')}"`).join(','));
                    }
                    if (maxLength === 0) {
                        // If no codes for the room, still add the room number row
                        csvRows.push(`"${room}","","","",""`);
                    }
                });

                const csvContent = csvRows.join('\n');
                const timestamp = new Date().toISOString().split('T')[0];
                downloadCsvFile(csvContent, `room_se_st_sv_inspection_${timestamp}.csv`);
            } catch (error) {
                console.error('Export failed:', error);
                showMessageModal('Export Failed', 'Failed to export data. Please try again.');
            }
        }

        // Export functions
        function exportToCsv() {
            try {
                const headers = ['Room', ...checkLabels];
                const csvRows = [];
                // Add headers, ensuring proper CSV escaping
                csvRows.push(headers.map(h => `"${String(h).replace(/"/g, '""')}"`).join(','));

                appState.rooms.forEach(room => {
                    const roomData = appState.checkData[room] || new Array(checkLabels.length).fill(null);
                    const rowData = [room, ...roomData.map(value => {
                        if (value === null) return ' ';
                        if (typeof value === 'string') return value; // Comments are strings
                        return value === 1 ? '1' : '0'; // Yes/No checks
                    })];
                    // Add data rows, ensuring proper CSV escaping
                    csvRows.push(rowData.map(c => `"${String(c).replace(/"/g, '""')}"`).join(','));
                });

                const csvContent = csvRows.join('\n');
                downloadCsvFile(csvContent, `room_inspection_${new Date().toISOString().split('T')[0]}.csv`);
            } catch (error) {
                console.error('Export failed:', error);
                showMessageModal('Export Failed', 'Failed to export data. Please try again.');
            }
        }

        function exportCodeToCsv() {
            try {
                const headers = ['Room', 'Code', 'Status', 'Comment'];
                const csvRows = [];
                // Add headers, ensuring proper CSV escaping
                csvRows.push(headers.map(h => `"${String(h).replace(/"/g, '""')}"`).join(','));

                // Iterate through rooms, then their codes to get the room name for each code
                for (const roomName in appState.roomCodes) {
                    appState.roomCodes[roomName].forEach(code => {
                        const uniqueCodeId = `${roomName}-${code}`;
                        const statusIndex = appState.checkData[uniqueCodeId];
                        const status = statusIndex !== null && statusIndex !== undefined ? codeStatusOptions[statusIndex] : '';
                        const comment = appState.codeSpecificComments[uniqueCodeId] || '';
                        
                        const rowData = [roomName, code, status, comment];
                        // Add data rows, ensuring proper CSV escaping
                        csvRows.push(rowData.map(c => `"${String(c).replace(/"/g, '""')}"`).join(','));
                    });
                }

                const csvContent = csvRows.join('\n');
                downloadCsvFile(csvContent, `code_inspection_${new Date().toISOString().split('T')[0]}.csv`);
            } catch (error) {
                console.error('Export failed:', error);
                showMessageModal('Export Failed', 'Failed to export data. Please try again.');
            }
        }

        function downloadCsvFile(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showMessageModal('Export Successful', 'Data exported successfully!');
        }

        // Modal functions
        function showResetModal(type) {
            document.getElementById('resetModal').classList.add('active');
            document.getElementById('resetModal').dataset.type = type;
        }

        function hideResetModal() {
            document.getElementById('resetModal').classList.remove('active');
        }

        function confirmReset() {
            const type = document.getElementById('resetModal').dataset.type;
            
            if (type === 'site') {
                appState.rooms = [];
                appState.checkData = {};
                appState.roomStatus = {};
                roomListTextarea.value = '';
            } else if (type === 'code') {
                appState.roomCodes = {};
                appState.codeSpecificComments = {};
                codeListTextarea.value = '';
            } else if (type === 'seStSv') {
                appState.seStSvRooms = [];
                appState.seStSvData = {};
                roomNumbersTextarea.value = '';
            }
            
            appState.currentRoomIndex = 0;
            appState.currentCodeRoomIndex = 0;
            appState.currentSeStSvRoomIndex = 0;
            appState.isInspectionMode = false;
            
            localStorage.removeItem('roomInspectionApp');
            hideResetModal();
            showMainMenu();
            showMessageModal('Reset Complete', 'Application has been reset successfully.');
        }

        function showFileUploadModal(type) {
            document.getElementById('fileUploadModal').classList.add('active');
            document.getElementById('fileUploadModal').dataset.type = type;
            document.getElementById('fileName').textContent = '';
            document.getElementById('jsonFileInput').value = '';
        }

        function hideFileUploadModal() {
            document.getElementById('fileUploadModal').classList.remove('active');
        }

        function uploadFile() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessageModal('No File Selected', 'Please select a JSON file to upload.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    appState = { ...appState, ...data };
                    saveDataToStorage();
                    hideFileUploadModal();
                    refreshUIFromState();
                    showMessageModal('Upload Successful', 'Data uploaded and loaded successfully!');
                } catch (error) {
                    console.error('Upload failed:', error);
                    showMessageModal('Upload Failed', 'Invalid JSON file. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function showMessageModal(title, message) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageContent').textContent = message;
            document.getElementById('messageModal').classList.add('active');
        }

        function hideMessageModal() {
            document.getElementById('messageModal').classList.remove('active');
        }
    </script>
</body>
</html>
